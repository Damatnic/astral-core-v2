/**
 * Mobile Chat Keyboard Optimizations
 * 
 * Comprehensive mobile-first CSS fixes for chat interface keyboard behavior
 * Addresses iOS Safari and Android Chrome virtual keyboard issues
 */

/* Mobile viewport units support for modern browsers */
:root {
  --mobile-vh: 100vh;
  --keyboard-height: 0px;
  --is-keyboard-open: 0;
  --safe-area-bottom: env(safe-area-inset-bottom, 0px);
}

/* Enhanced mobile chat styles */
@media (max-width: 768px) {
  /* Main chat view adjustments */
  .chat-view {
    height: 100vh;
    height: var(--mobile-vh, 100vh);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Chat messages area optimization */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    /* Dynamic bottom padding to account for chat composer and keyboard */
    padding-bottom: calc(
      140px + var(--keyboard-height, 0px) + var(--safe-area-bottom)
    );
    /* Momentum scrolling for iOS */
    -webkit-overflow-scrolling: touch;
    /* Smooth scrolling behavior */
    scroll-behavior: smooth;
    /* Hide scrollbar for cleaner look */
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .chat-messages::-webkit-scrollbar {
    display: none;
  }

  /* Mobile chat composer fixes */
  .chat-composer,
  .mobile-composer {
    position: fixed !important;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    padding-bottom: max(1rem, var(--safe-area-bottom));
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px) saturate(1.2);
    border-top: 1px solid var(--border-color);
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    /* Smooth transitions */
    transition:
      transform 0.2s ease-out,
      background-color 0.2s ease;
    /* Additional positioning safeguards */
    width: 100vw;
    min-height: 60px;
    /* Prevent any layout shifts */
    contain: layout style;
    /* Force hardware acceleration for smooth animations */
    will-change: transform;
    transform: translateZ(0);
  }

  /* Dark mode support */
  [data-theme="dark"] .chat-composer,
  [data-theme="dark"] .mobile-composer {
    background: rgba(30, 30, 40, 0.98);
    border-top: 1px solid rgba(102, 126, 234, 0.2);
  }

  /* Mobile input optimizations */
  .chat-input {
    flex: 1;
    font-size: 16px !important; /* Prevent iOS zoom */
    padding: 12px 16px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    background-color: var(--bg-tertiary);
    min-height: 44px; /* WCAG touch target */
    width: 100%;
    outline: none;
    transition: all 0.2s ease;
    /* Improved text rendering */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .chat-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    background-color: var(--bg-primary);
  }

  /* Mobile-optimized buttons */
  .chat-send-btn {
    min-width: 44px !important;
    min-height: 44px !important;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin-left: 8px;
    flex-shrink: 0;
    /* Touch feedback */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  .chat-send-btn:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
  }

  /* Emergency button mobile styling */
  .btn-danger {
    min-height: 44px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    /* Touch optimization */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  .btn-danger:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
  }

  /* Keyboard state adjustments */
  .keyboard-open .chat-messages {
    padding-bottom: calc(
      160px + var(--keyboard-height, 0px) + var(--safe-area-bottom)
    );
  }

  .keyboard-open .chat-view {
    height: calc(100vh - var(--keyboard-height, 0px));
  }

  /* Enhanced keyboard state handling */
  .keyboard-open .chat-composer,
  .keyboard-open .mobile-composer {
    /* Keep composer at the bottom edge when keyboard is open */
    bottom: 0;
    /* Adjust for keyboard height on some Android devices */
    transform: translateY(calc(var(--keyboard-height, 0px) * -0.1))
      translateZ(0);
  }

  .keyboard-closed .chat-composer,
  .keyboard-closed .mobile-composer {
    bottom: 0;
    transform: translateZ(0);
  }

  /* Mobile focused input state */
  .mobile-focused {
    position: relative;
    z-index: 1001;
    /* Improved focus visibility */
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
  }

  /* Chat header mobile adjustments */
  .chat-header {
    flex-shrink: 0;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-primary);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .chat-header-actions {
    gap: 0.5rem;
  }

  .chat-header-actions .btn-sm {
    padding: 8px 12px;
    font-size: 14px;
    min-height: 44px;
  }

  /* Message typography optimization */
  .chat-message {
    font-size: 16px;
    line-height: 1.4;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Message bubbles mobile styling */
  .message-bubble {
    max-width: calc(100% - 2rem);
    padding: 12px 16px;
    border-radius: 18px;
    margin-bottom: 8px;
  }

  /* Improved touch targets for interactive elements */
  .message-bubble-wrapper button,
  .message-bubble-wrapper a {
    min-height: 44px;
    min-width: 44px;
    padding: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
}

/* Landscape orientation adjustments */
@media (max-width: 768px) and (orientation: landscape) {
  .chat-composer,
  .mobile-composer {
    padding: 0.75rem;
    padding-bottom: max(0.75rem, var(--safe-area-bottom));
  }

  .chat-messages {
    padding: 0.75rem;
    padding-bottom: calc(
      120px + var(--keyboard-height, 0px) + var(--safe-area-bottom)
    );
  }

  .chat-header {
    padding: 0.75rem;
  }
}

/* Very small screens (iPhone SE, older Android) */
@media (max-width: 374px) {
  .chat-composer,
  .mobile-composer {
    padding: 0.75rem 0.5rem;
  }

  .chat-input {
    padding: 10px 14px;
    font-size: 16px !important;
  }

  .chat-send-btn {
    min-width: 40px !important;
    min-height: 40px !important;
  }

  .btn-danger {
    padding: 6px 12px;
    font-size: 13px;
  }
}

/* High DPI / Retina display optimizations */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .chat-input,
  .chat-send-btn,
  .btn-danger {
    /* Sharper borders on high DPI */
    border-width: 0.5px;
  }
}

/* Accessibility enhancements for mobile */
@media (max-width: 768px) {
  /* Focus visible improvements */
  .chat-input:focus-visible,
  .chat-send-btn:focus-visible,
  .btn-danger:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
  }

  /* Reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .chat-composer,
    .mobile-composer,
    .chat-input,
    .chat-send-btn,
    .btn-danger {
      transition: none;
    }

    .chat-messages {
      scroll-behavior: auto;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .chat-input {
      border-width: 2px;
    }

    .chat-composer,
    .mobile-composer {
      border-top-width: 2px;
    }
  }
}

/* iOS Safari specific fixes */
@supports (-webkit-touch-callout: none) {
  .chat-view {
    /* Fix for iOS Safari viewport issues */
    height: -webkit-fill-available;
  }

  .chat-input {
    /* Prevent iOS Safari zoom on input focus */
    transform: translateZ(0);
    -webkit-appearance: none;
    appearance: none;
  }

  /* Fix for iOS Safari bottom safe area */
  .chat-composer,
  .mobile-composer {
    padding-bottom: max(1rem, env(safe-area-inset-bottom));
  }
}

/* Mobile-optimized form inputs */
@media (max-width: 768px) {
  .mobile-optimized {
    /* Enhanced touch target */
    min-height: 44px;
    padding: 12px 16px;
    /* Prevent iOS zoom */
    font-size: 16px !important;
    /* Smooth touch interactions */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    /* Improved visual feedback */
    transition: all 0.2s ease;
  }

  .mobile-optimized:focus,
  .mobile-focused {
    /* Enhanced focus state for mobile */
    border-color: var(--primary-color) !important;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2) !important;
    background-color: var(--bg-primary);
    /* Ensure visibility during keyboard */
    position: relative;
    z-index: 1001;
  }

  .mobile-optimized:active {
    /* Touch feedback */
    transform: scale(0.99);
  }

  /* Textarea specific mobile optimizations */
  textarea.mobile-optimized {
    min-height: 88px; /* Double the touch target for text areas */
    resize: vertical;
    line-height: 1.4;
  }

  /* Form group mobile spacing */
  .form-group-enhanced,
  .form-group {
    margin-bottom: 1rem;
  }

  /* Label improvements for mobile */
  .form-group-enhanced label,
  .form-group label {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
  }

  /* Error and help text mobile styling */
  .invalid-feedback {
    font-size: 14px;
    margin-top: 0.25rem;
    padding: 0.25rem 0;
  }

  .form-text {
    font-size: 13px;
    margin-top: 0.25rem;
    color: var(--text-secondary);
  }
}

/* Progressive enhancement for CSS env() support */
@supports (padding: max(0px)) {
  .chat-composer,
  .mobile-composer {
    padding-left: max(1rem, env(safe-area-inset-left));
    padding-right: max(1rem, env(safe-area-inset-right));
    padding-bottom: max(1rem, env(safe-area-inset-bottom));
  }

  .chat-messages {
    padding-left: max(1rem, env(safe-area-inset-left));
    padding-right: max(1rem, env(safe-area-inset-right));
  }
}
